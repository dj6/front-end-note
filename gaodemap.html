<!DOCTYPE html>
<html>
<head>
      <meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
      <title>城市下拉列表</title>
      <style type="text/css">
        body{
            margin:0;
            height:100%;
            width:100%;
            position:absolute;
        }
        #mapContainer{
            position: absolute;
            top:0;
            left: 0;
            right:0;
            bottom:0;
        }
        #tip{
            height:45px;
            background-color:#fff;
            padding-left:10px;
            padding-right:10px;
            border:1px solid #969696;
            position:absolute;
            font-size:12px;
            right:10px;
            bottom:20px;
            border-radius:3px;
            line-height:45px;
        }
      </style>
</head>
<body>
      <div id="mapContainer"></div>
      <div id="tip">
            省：<select id='province' style="width:100px"  onchange='search(this)'></select>
            市：<select id='city' style="width:100px"  onchange='search(this)'></select>
            区：<select id='district' style="width:100px" onchange='search(this)'></select>
            商圈：<select id='biz_area' style="width:100px"></select>
      </div>

     <script type="text/javascript" src="http://webapi.amap.com/maps?v=1.3&key=9d4f5c2078ba12cb9d9d09c4e81c95d0"></script>
     <script type='text/javascript' src='FileSaver.min.js'></script>
     <script type="text/javascript">
        var mapObj, district, polygons=[], citycode, asynFlag = 0;

        var geojson = new Geojson();
        var features = [];

        var citySelect = document.getElementById('city');
        var districtSelect = document.getElementById('district');
        var areaSelect = document.getElementById('biz_area');

        mapObj = new AMap.Map('mapContainer',{
            resizeEnable: true,
            layers: [
                new AMap.TileLayer()
            ],
            view: new AMap.View2D({
                center: new AMap.LngLat(116.30946,39.937629),
                zoom: 3
            })
        });

        var provinceList = ['北京市', '天津市', '河北省', '山西省', '内蒙古自治区', '辽宁省', '吉林省','黑龙江省', '上海市', '江苏省', '浙江省', '安徽省', '福建省', '江西省', '山东省','河南省', '湖北省', '湖南省', '广东省', '广西壮族自治区', '海南省', '重庆市','四川省', '贵州省', '云南省', '西藏自治区', '陕西省', '甘肃省', '青海省', '宁夏回族自治区', '新疆维吾尔自治区', '台灣', '香港特别行政区', '澳门特别行政区'];
        var provinceSelect = document.getElementById('province');
        var content = '<option>--请选择--</option>';
        for(var i =0, l = provinceList.length; i < l; i++){
          content += '<option value="province">'+provinceList[i]+'</option>';
          provinceSelect.innerHTML = content;
        }

        //行政区划查询

        AMap.service(["AMap.DistrictSearch"], function() {
            var opts = {
                subdistrict: 1,   //返回下一级行政区
                extensions: 'all',  //返回行政区边界坐标组等具体信息
                level:'city'  //查询行政级别为 市
            };

            //实例化DistrictSearch
            district = new AMap.DistrictSearch(opts);
        });



        function getData(e) {
              var dList = e.districtList;
              for(var m = 0,ml = dList.length; m < ml; m++){
                var data = e.districtList[m].level;
                var bounds = e.districtList[m].boundaries;

                //只绘制 区, 且 本级别行政区划是上一级区划的下级行政区
                if(data == "district" && dList[m].citycode === citycode){
                console.log('citycode' + citycode);
                console.log('owncode' +dList[m].citycode);

                  if(bounds) {
                    for(var i =0, l = bounds.length; i < l; i++){
                      //生成行政区划polygon

                      var polygon = new AMap.Polygon({
                        map:mapObj,
                        strokeWeight:1,
                        strokeColor:'#CC66CC',
                        fillColor:'#CCF3FF',
                        fillOpacity:0.7,
                        path:bounds[i]
                      });
                      var thisBound = polygon.getBounds();

                      polygons.push(polygon);

                    }
                    mapObj.setFitView();//地图自适应
                  }
                }

                var list = e.districtList || [],
                    subList =[], level, nextLevel;
                if(list.length >= 1) {
                  subList = list[0].districtList;
                  level = list[0].level;
                }

                //清空下一级别的下拉列表
                if(level === 'province'){

                  nextLevel = 'city';
                  citySelect.innerHTML = '';
                  districtSelect.innerHTML = '';
                  areaSelect.innerHTML = '';
                }else if(level === 'city'){

                  nextLevel = 'district';
                  districtSelect.innerHTML = '';
                  areaSelect.innerHTML = '';
                } else if(level === 'district') {

                    nextLevel = 'biz_area';
                    areaSelect.innerHTML = '';
                }

                if(subList){
                  var contentSub = '<option>--请选择--</option>';
                  for(var i=0,l=subList.length; i<l; i++){
                    var name = subList[i].name;
                    var levelSub = subList[i].level;
                    var cityCode = subList[i].citycode;
                    contentSub += '<option value="'+levelSub+'|'+cityCode+'">'+name+'</option>';
                    document.querySelector('#'+levelSub).innerHTML = contentSub;
                  }
                }
              }
        }

        function search(obj) {
          //清除地图上所有覆盖物
          for(var i = 0, l = polygons.length; i < l; i ++){
            polygons[i].setMap(null);
          }

          var option = obj[obj.options.selectedIndex];
          var arrTemp = option.value.split('|');

          console.log(arrTemp);
          var level = arrTemp[0];//行政级别
          citycode = arrTemp[1];// 城市编码
          var keyword = option.text; //关键字

          district.setLevel(level); //行政区级别
          //行政区查询
          district.search(keyword, function(status, result){

            getData(result);
            // !!
            getGeojson(result.districtList[0]);


          });
        }

        //need id, name, childNum, cp, cooridates
        function Feature() {
            this.type = "Feature";
            this.id = '';
            this.properties = {
                "name" : '',
                "cp" : [],
                "childNum" : 1
            };
            this.geometry = {
                "type" : "Polygon",
                "coordinates" : []
            };
        }

        //need features
        function Geojson() {
            this.type  = "FeatureCollection";
            this.features =[];
        }

        function getGeojson(data) {
            var level = data.level;
            switch (level) {
                case 'province':
                    getProvinceGeojson(data);
                    break;
                case 'city':
                    getCityGeojson(data, callback);
                    break;
                case 'district':
                    getDistGeojson(data);
                    break;
            }

        }

        function callback() {
            if (asynFlag === 0) {
                geojson.features = features;
                // console.log(JSON.stringify(geojson));
                console.log('end');
                compressAndDownload(geojson);
                // writeFile("d:\\tt.json", geojson);
        // "f:\\421.json"
                geojson = {};
                features = [];
            }
        }

        function getProvinceGeojson(data) {

        }

        function getCityGeojson(data, callback) {


            var dList = data.districtList;
            console.log(data);
            var cityCode = data.citycode;

            for(var m = 0, mlength = dList.length; m < mlength; m++) {

                var keyword = dList[m].name;
                asynFlag++;
                console.log(keyword);
                district.search(keyword, function(status, result){
                    asynFlag--;
                    console.log('result');
                    console.log(result);
                    var subDistrictList = result.districtList;
                    var feature = createFeature(subDistrictList, citycode);
                    features.push(feature);
                    console.log(features);
                    feature = null;
                    callback();
                    // for (var s = 0, slength = subDistrictList.length; s < slength; s++) {
                    //  console.log(feature);
                    //  createFeature(feature, subDistrictList[s], cityCode);
                    //  console.log(feature);
                    //  features.push(feature);
                    //  feature = {};
                    //  callback();
                    // }
                });

            }
        }

        function getDistGeojson(data) {

        }

        function createFeature(districtList, citycode) {
            var feature = new Feature();
            var cp = [];
            var coordinatesSet = [];
            var district = {};

            for (var d = 0, dlength = districtList.length; d < dlength; d++) {
                district = districtList[d];
                if (district.citycode === citycode) {
                    // console.log(district.adcode);
                    feature.id = district.adcode;
                    // console.log(district.name);
                    feature.properties.name = district.name;
                    feature.properties.childNum = district.boundaries.length;

                    if(feature.properties.childNum > 1) {
                        feature.geometry.type = "MultiPolygon";
                    }

                    cp[0] = district.center.lng;
                    cp[1] = district.center.lat;
                    feature.properties.cp = cp;
                    cp = [];
                    getCoo(district, coordinatesSet);
                    console.log(coordinatesSet.length);
                    feature.geometry.coordinates = coordinatesSet;
                    console.log(coordinatesSet.length);
                    coordinatesSet = [];
                    console.log(feature);
                    return feature;
                }

                district = {};
            }
        }

        function getCoo (obj, coo) {
            var point = [];
            var cooItem = [];
            var cooSet = [];
            var plength = obj.boundaries.length;

            // feature为Polygon
            if (plength === 1) {
                var boundary = obj.boundaries[0];
                for (var b = 0; b < boundary.length; b++) {
                    point[0] = boundary[b].lng;
                    point[1] = boundary[b].lat;
                    cooItem.push(point);
                    point = [];
                }
                coo.push(cooItem);

            // feature为MultiPolygon
            } else {
                for (var p = 0; p < plength; p++) {
                    var boundary = obj.boundaries[p];
                    for (var b = 0; b < boundary.length; b++) {
                        point[0] = boundary[b].lng;
                        point[1] = boundary[b].lat;
                        cooItem.push(point);
                        point = [];
                    }
                    cooSet.push(cooItem);
                    cooItem = [];
                    coo.push(cooSet);
                    cooSet = [];

                }

            }

        }

        function writeFile(fileName, json) {
        // "f:\\421.json"
        // for (var i = 0; i < cos.length; i++) {
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        var f1 = fso.createtextfile(fileName, true, true);

        var str = JSON.stringify(json);
        // console.log(str);
        f1.write(str);
        f1.close();
        // }
        }

        function compressAndDownload(geojson) {
        // if (! BUILD_CONFIG.source) {
        // code = jsCompress(code);
        // }

        var str = JSON.stringify(geojson);
        // console.log(str);
        var blob = new Blob([str], {
        type: 'text/plain;charset=utf8'
        });

        var fileName = ['success'];
        // if (BUILD_CONFIG.amd) {
        // fileName.push('amd');
        // }
        // if (BUILD_CONFIG.source) {
        // fileName.push('source');
        // }
        fileName.push('json');
        saveAs(blob, fileName.join('.'));

        // builderLog('<br />Completed');

        // setTimeout(function () {
        //     window.close();
        // }, 3000);

        // document.getElementById('tip').innerHTML = '构建完毕';
        }


    </script>
</body>
</html>


